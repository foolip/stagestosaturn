<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Stages to Saturn</title>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8"/>
<link rel="stylesheet" href="stylesheet.css" type="text/css"/>
</head>
<body>
<p style="text-align: center; margin-top: 4em"><i>
To<br/>Wernher von Braun<br/>1912&ndash;1977<br/>
and the men and women<br/>who built the Saturn</i></p>
<iframe src="foreword.htm"></iframe>
<iframe src="preface.htm"></iframe>
<iframe src="acknowl.htm"></iframe>
<iframe src="ch1.htm"></iframe>
<iframe src="ch2.htm"></iframe>
<iframe src="ch3.htm"></iframe>
<iframe src="ch4.htm"></iframe>
<iframe src="ch5.htm"></iframe>
<iframe src="ch6.htm"></iframe>
<iframe src="ch7.htm"></iframe>
<iframe src="ch8.htm"></iframe>
<iframe src="ch9.htm"></iframe>
<iframe src="ch10.htm"></iframe>
<iframe src="ch11.htm"></iframe>
<iframe src="ch12.htm"></iframe>
<iframe src="ch13.htm"></iframe>
<script src="sanitize.js" type="text/javascript"></script>
<script>
window.addEventListener('load', function() {
    // replace iframes with their sanitized content
    forEach(document.querySelectorAll('iframe'), function(iframe) {
        sanitize(iframe.contentDocument);
        moveChildren(iframe.contentDocument.body, document.body);
        remove(iframe);
    });

    // remove the scripts
    forEach(document.querySelectorAll('script'), remove);

    // sanitize whitespace
    document.body.normalize();
    var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT,
                                           null, false);
    while (walker.nextNode()) {
        var node = walker.currentNode;
        node.data = node.data.replace(/\s{2,}/g, '\n');
    }

    // rewrite page IDs (validator wants an XML name)
    forEach(document.querySelectorAll('.newpage'), function(elm) {
        if (/^\d+$/.test(elm.id)) {
            elm.id = 'p' + elm.id;
        }
    });

    // rewrite links
    forEach(document.querySelectorAll('a[href]'), function(a) {
        var href = a.getAttribute('href');
        var m = /^(?:(\w+)\.htm)?(?:#([\w.]+))?$/.exec(href);
        if (!m) {
            return;
        }
        var page = m[1];
        var frag = m[2];

        if (frag) {
            // prepend p to page references
            if (/^\d+$/.test(frag)) {
                frag = 'p' + frag;
            }
            // foo.htm#bar -> #bar
            href = '#' + frag;
        } else if (page) {
            // foo.htm to #foo
            href = '#' + page;
        } else {
            assert(false);
        }
        a.setAttribute('href', href);
    });

    // serialize this document
    //var html = document.documentElement.outerHTML;
    var html = new XMLSerializer().serializeToString(document);
    html = html.replace(/.*<html/, '<html').replace('><head', '>\n<head');

    // show the result in a textarea
    var textarea = document.createElement('textarea');
    textarea.setAttribute('style', 'width: 100%; height: 200px');
    textarea.textContent = html;
    document.body.insertBefore(textarea, document.body.firstChild);

    // make it prettty
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'web.css';
    document.head.appendChild(link);
});
</script>
</body>
</html>
